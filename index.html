<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Relat√≥rio de Atividades - Instrumenta√ß√£o Industrial</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  * { box-sizing:border-box; margin:0; padding:0; font-family:'Verdana', Arial, sans-serif; }
  html,body { height:100%; -webkit-overflow-scrolling:touch; }
  body { background:#f2f4f7; color:#333; display:flex; flex-direction:column; min-height:100vh; }
  
  header { background:#1f3b70; color:#fff; padding:1.2rem; display:flex; align-items:center; justify-content:space-between; font-size:1.5rem; position:sticky; top:0; z-index:100; }
  header img { height:50px; background:#fff; padding:5px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.3); }

  .container { flex:1; overflow-y:auto; padding:1rem; -webkit-overflow-scrolling:touch; }

  .atividade { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:1rem; margin-bottom:1rem; }
  .atividade label { font-weight:bold; margin-bottom:0.3rem; display:block; text-transform:uppercase; }
  .atividade input, .atividade textarea, .atividade select { text-transform:uppercase; width:100%; padding:0.8rem; margin-bottom:0.8rem; border:1px solid #ccc; border-radius:8px; font-size:1.1rem; background:#fafafa; }
  .atividade textarea { min-height:100px; resize:vertical; }

  .btn-remover, .btn-duplicar, .btn-concluir { background:#1f3b70; color:#fff; border:none; padding:0.6rem; border-radius:8px; cursor:pointer; width:48%; margin-right:2%; margin-top:0.5rem; }
  .btn-remover:hover, .btn-duplicar:hover, .btn-concluir:hover { background:#12274b; }

  .btn-fab { position:fixed; bottom:80px; right:20px; background:#f1c40f; color:#fff; border:none; border-radius:50%; width:60px; height:60px; font-size:2rem; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:200; }
  .btn-fab:hover { background:#d4ac0d; }

  footer { background:#fff; padding:0.8rem; display:flex; justify-content:space-around; border-top:1px solid #ddd; position:sticky; bottom:0; }
  footer button { flex:1; margin:0 0.3rem; padding:0.8rem; font-size:1rem; border:none; border-radius:10px; cursor:pointer; color:#fff; }
  .btn-pdf { background:#1f3b70; }
  .btn-pdf:hover { background:#12274b; }
  .btn-share { background:#f1c40f; color:#fff; }
  .btn-share:hover { background:#d4ac0d; }

  @media (max-width:600px){ header{font-size:1.2rem;} .atividade input, .atividade textarea{font-size:1rem;} footer button{font-size:0.9rem; padding:0.7rem;} }
</style>
</head>
<body>
<header>
  üìã RELAT√ìRIO DE ATIVIDADES
  <img src="https://media-genial-analisa.genialinvestimentos.com.br/wp-content/uploads/2021/12/22171726/m-dias-branco-logo-azul.png" alt="Logo M. Dias Branco">
</header>

<div class="container">
  <div class="atividade" id="tecnico-responsavel">
    <label><b>T√âCNICO INSTRUMENTISTA RESPONS√ÅVEL:</b></label>
    <div>
      <input type="checkbox" id="dario_moraes" name="tecnico" value="D√ÅRIO / MORAES">
      <label for="dario_moraes">D√ÅRIO / MORAES</label>
    </div>
    <div>
      <input type="checkbox" id="outro_tecnico" name="tecnico" value="OUTRO T√âCNICO">
      <label for="outro_tecnico">OUTRO T√âCNICO</label>
    </div>
    <button class="btn-concluir" onclick="marcarTodasConcluidas()">MARCAR TODAS COMO CONCLU√çDAS</button>
  </div>

  <div id="atividades"></div>
</div>

<button class="btn-fab" onclick="adicionarAtividade()">+</button>
<footer>
  <button class="btn-pdf" id="btn-pdf">üìÑ PDF</button>
  <button class="btn-share" onclick="compartilharWhatsApp()">üì§ WhatsApp</button>
</footer>

<template id="template-atividade">
  <div class="atividade">
    <label>N¬∫ DA ORDEM/NOTA:</label>
    <input type="text" placeholder="Ex: 40803175" required>
    
    <label>TIPO DE INSTRUMENTO:</label>
    <input type="text" placeholder="Ex: Transmissor de press√£o" required>
    
    <label>DESCRI√á√ÉO DA ATIVIDADE:</label>
    <textarea placeholder="Descri√ß√£o detalhada da atividade" required></textarea>
    
    <label>ATIVIDADES REALIZADAS:</label>
    <textarea placeholder="Liste as atividades realizadas" required></textarea>
    
    <label>STATUS FINAL:</label>
    <select>
      <option>SELECIONE</option>
      <option>CONCLU√çDO</option>
      <option>N√ÉO CONCLU√çDO</option>
      <option>EM ANDAMENTO</option>
    </select>

    <button class="btn-remover" onclick="removerAtividade(this)">REMOVER</button>
    <button class="btn-duplicar" onclick="duplicarAtividade(this)">DUPLICAR</button>
  </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const atividadesDiv = document.getElementById("atividades");

  // Carregar rascunho do localStorage
  if(localStorage.getItem("atividadesInstrumentacao")){
    atividadesDiv.innerHTML = localStorage.getItem("atividadesInstrumentacao");
  }

  function salvarRascunho(){
    localStorage.setItem("atividadesInstrumentacao", atividadesDiv.innerHTML);
  }

  function adicionarAtividade(){
    const template = document.getElementById("template-atividade");
    const clone = template.content.cloneNode(true);
    atividadesDiv.appendChild(clone);
    salvarRascunho();
    setTimeout(()=>{ 
      const input = clone.querySelector("input,textarea,select");
      if(input){input.scrollIntoView({behavior:'smooth',block:'center'}); input.focus();}
    },100);
  }

  function removerAtividade(btn){
    if(confirm("TEM CERTEZA QUE DESEJA REMOVER ESTA ATIVIDADE?")){
      btn.parentElement.remove();
      salvarRascunho();
    }
  }

  function duplicarAtividade(btn){
    const atividade = btn.parentElement;
    const clone = atividade.cloneNode(true);
    atividadesDiv.appendChild(clone);
    salvarRascunho();
  }

  function marcarTodasConcluidas(){
    const selects = document.querySelectorAll("#atividades .atividade select");
    selects.forEach(s=>s.value = "CONCLU√çDO");
    salvarRascunho();
    alert("TODAS AS ATIVIDADES FORAM MARCADAS COMO CONCLU√çDAS!");
  }

  function gerarPDF(){
    const dataAtual = new Date().toLocaleDateString();
    const tecnicosSelecionados = Array.from(document.querySelectorAll('input[name="tecnico"]:checked'))
                                     .map(e=>e.value).join(", ") || "N√ÉO SELECIONADO";

    let relatorio = document.createElement("div");
    relatorio.innerHTML = `
      <style>
        @page {margin:20mm;}
        body {font-family:'Verdana', Arial, sans-serif; text-transform:uppercase;}
        .footer-page {position: fixed; bottom: 0; width: 100%; text-align: center; font-size:12px; color:#555;}
        .atividade-pdf {page-break-inside: avoid; border-radius:12px; padding:1rem; margin-bottom:1rem; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
      </style>
      <div style="
          display:flex;justify-content:space-between;align-items:center;
          background:#1f3b70;color:#fff;padding:1rem 1.5rem;border-radius:12px;
          box-shadow:0 4px 12px rgba(0,0,0,0.2);margin-bottom:1.5rem;">
        <div style="line-height:1.4;">
          <h1 style='margin:0;font-size:1.6rem;'>üìä RELAT√ìRIO DE ATIVIDADES</h1>
          <p style='margin:0.2rem 0;'><b>EMPRESA:</b> GME - M. DIAS BRANCO</p>
          <p style='margin:0.2rem 0;'><b>DATA:</b> ${dataAtual}</p>
          <p style='margin:0.2rem 0;'><b>T√âCNICO(OS) RESPONS√ÅVEL(EIS):</b> ${tecnicosSelecionados}</p>
        </div>
        <img src='https://media-genial-analisa.genialinvestimentos.com.br/wp-content/uploads/2021/12/22171726/m-dias-branco-logo-azul.png' 
             alt='Logo M. Dias Branco' style='height:70px;display:block;'>
      </div>
    `;

    const fragment = document.createDocumentFragment();
    const atividades = document.querySelectorAll("#atividades .atividade");
    atividades.forEach((a,i)=>{
      const inputs = a.querySelectorAll("input[type='text']");
      const textareas = a.querySelectorAll("textarea");
      const select = a.querySelector("select");
      if(inputs.length > 0 && textareas.length >= 2 && select){
        const ordem = inputs[0].value.toUpperCase() || "-";
        const instrumento = inputs[1].value.toUpperCase() || "-";
        const descricao = textareas[0].value.toUpperCase() || "-";
        const realizadas = textareas[1].value.toUpperCase() || "-";
        const status = select.value.toUpperCase() || "-";

        const bgColor = (i % 2 === 0) ? "#1f3b70" : "#3b5998";

        const div = document.createElement("div");
        div.className = "atividade-pdf";
        div.style.background = bgColor;
        div.style.color = "#fff";
        div.innerHTML = `
          <p style="margin-bottom:0.8rem;font-weight:bold;color:#fff;">üìù ATIVIDADE ${i+1}</p>
          <p><b>ORDEM:</b> ${ordem}</p>
          <p><b>INSTRUMENTO:</b> ${instrumento}</p>
          <p><b>DESCRI√á√ÉO:</b><br>${descricao}</p>
          <p><b>ATIVIDADES REALIZADAS:</b><br>${realizadas}</p>
          <p><b>STATUS FINAL:</b> ${status}</p>
        `;
        fragment.appendChild(div);
      }
    });
    relatorio.appendChild(fragment);
    relatorio.innerHTML += `<div class="footer-page">P√ÅGINA <span class="pageNumber"></span></div>`;

    html2pdf().set({
      margin:[10,10,20,10],
      filename:'RELATORIO_ATIVIDADES_INSTRUMENTACAO.pdf',
      image:{ type:'jpeg', quality:0.98 },
      html2canvas:{ scale:2 },
      jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' },
      pagebreak:{ mode:['css','legacy'] }
    }).from(relatorio).toPdf().get('pdf').then(pdf=>{
      const totalPages = pdf.internal.getNumberOfPages();
      for(let i=1;i<=totalPages;i++){
        pdf.setPage(i);
        pdf.setFontSize(10);
        pdf.setTextColor(100);
        pdf.text(`P√ÅGINA ${i} DE ${totalPages}`, pdf.internal.pageSize.getWidth()/2, pdf.internal.pageSize.getHeight()-10, {align:'center'});
      }
    }).save();
  }

  function compartilharWhatsApp(){
    const tecnicosSelecionados = Array.from(document.querySelectorAll('input[name="tecnico"]:checked')).map(e=>e.value).join(", ") || "N√ÉO SELECIONADO";
    const agora = new Date();
    const data = agora.toLocaleDateString();
    const hora = agora.toLocaleTimeString();

    let atividades = document.querySelectorAll("#atividades .atividade");
    let resumo = {TOTAL: atividades.length, CONCLU√çDO:0, "N√ÉO CONCLU√çDO":0, "EM ANDAMENTO":0};
    let textoAtividades = "";

    atividades.forEach((a,i)=>{
      const inputs = a.querySelectorAll("input[type='text']");
      const textareas = a.querySelectorAll("textarea");
      const select = a.querySelector("select");
      if(inputs.length > 0 && textareas.length >= 2 && select){
        const ordem = inputs[0].value.toUpperCase() || "-";
        const instrumento = inputs[1].value.toUpperCase() || "-";
        const descricao = textareas[0].value.toUpperCase() || "-";
        const realizadas = textareas[1].value.toUpperCase() || "-";
        const status = select.value.toUpperCase() || "-";

        if(resumo[status] !== undefined) resumo[status]++;
        textoAtividades += `ATIVIDADE ${i+1}\nORDEM: ${ordem}\nINSTRUMENTO: ${instrumento}\nDESCRI√á√ÉO: ${descricao}\nATIVIDADES: ${realizadas}\nSTATUS FINAL: ${status}\n\n`;
      }
    });

    let texto = `üìë RELAT√ìRIO DE ATIVIDADES DE INSTRUMENTA√á√ÉO\n\nüìÖ DATA: ${data}\nüïê HORA: ${hora}\nüë∑ T√âCNICO(OS) RESPONS√ÅVEL(EIS): ${tecnicosSelecionados}\n\nRESUMO:\nTOTAL: ${resumo.TOTAL}\nCONCLU√çDO: ${resumo.CONCLU√çDO}\nN√ÉO CONCLU√çDO: ${resumo["N√ÉO CONCLU√çDO"]}\nEM ANDAMENTO: ${resumo["EM ANDAMENTO"]}\n\n${textoAtividades}`;

    const url = "https://wa.me/?text=" + encodeURIComponent(texto);
    window.open(url,"_blank");
  }

  adicionarAtividade();
  document.getElementById('btn-pdf').addEventListener('click', gerarPDF);

  window.adicionarAtividade = adicionarAtividade;
  window.removerAtividade = removerAtividade;
  window.compartilharWhatsApp = compartilharWhatsApp;
  window.duplicarAtividade = duplicarAtividade;
  window.marcarTodasConcluidas = marcarTodasConcluidas;

  // Atualizar rascunho quando campos s√£o alterados
  atividadesDiv.addEventListener('input', salvarRascunho);
});
</script>
</body>
</html>
